/*! jsforce - v1.4.1 - 2015-02-25 */
!function(a){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=a();else if("function"==typeof define&&define.amd)define([],a);else{var b;b="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,b=b.jsforce||(b.jsforce={}),b=b.modules||(b.modules={}),b=b.api||(b.api={}),b.Bulk=a()}}(function(){return function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b){(function(a){var c=jsforce.require("inherits"),d=jsforce.require("stream"),e=d.Stream,f=jsforce.require("events"),g=jsforce.require("underscore"),h=jsforce.require("./record-stream"),i=(jsforce.require("./csv"),jsforce.require("./promise")),j=jsforce.require("./http-api"),k=function(a,b,c,d,e){this._bulk=a,this.type=b,this.operation=c,this.options=d||{},this.id=e,this.state=this.id?"Open":"Unknown",this._batches={}};c(k,f.EventEmitter),k.prototype.info=function(a){return this._jobInfo||(this._jobInfo=this.check()),this._jobInfo.thenCall(a)},k.prototype.open=function(a){{var b=this,c=this._bulk;c._logger}if(!this._jobInfo){var d=this.operation.toLowerCase();"harddelete"===d&&(d="hardDelete");var e=['<?xml version="1.0" encoding="UTF-8"?>','<jobInfo  xmlns="http://www.force.com/2009/06/asyncapi/dataload">',"<operation>"+d+"</operation>","<object>"+this.type+"</object>",this.options.extIdField?"<externalIdFieldName>"+this.options.extIdField+"</externalIdFieldName>":"","<contentType>CSV</contentType>","</jobInfo>"].join("");this._jobInfo=c._request({method:"POST",path:"/job",body:e,headers:{"Content-Type":"application/xml; charset=utf-8"},responseType:"application/xml"}).then(function(a){return b.emit("open",a.jobInfo),b.id=a.jobInfo.id,b.state=a.jobInfo.state,a.jobInfo},function(a){throw b.emit("error",a),a})}return this._jobInfo.thenCall(a)},k.prototype.createBatch=function(){var a=new l(this),b=this;return a.on("queue",function(){b._batches[a.id]=a}),a},k.prototype.batch=function(a){var b=this._batches[a];return b||(b=new l(this,a),this._batches[a]=b),b},k.prototype.check=function(a){var b=this,c=this._bulk,d=c._logger;return this._jobInfo=this._waitAssign().then(function(){return c._request({method:"GET",path:"/job/"+b.id,responseType:"application/xml"})}).then(function(a){return d.debug(a.jobInfo),b.id=a.jobInfo.id,b.type=a.jobInfo.object,b.operation=a.jobInfo.operation,b.state=a.jobInfo.state,a.jobInfo}),this._jobInfo.thenCall(a)},k.prototype._waitAssign=function(a){return(this.id?new i({id:this.id}):this.open()).thenCall(a)},k.prototype.list=function(a){var b=this,c=this._bulk,d=c._logger;return this._waitAssign().then(function(){return c._request({method:"GET",path:"/job/"+b.id+"/batch",responseType:"application/xml"})}).then(function(a){d.debug(a.batchInfoList.batchInfo);var b=a.batchInfoList;return b=g.isArray(b.batchInfo)?b.batchInfo:[b.batchInfo]}).thenCall(a)},k.prototype.close=function(){var a=this;return this._changeState("Closed").then(function(b){return a.id=null,a.emit("close",b),b},function(b){throw a.emit("error",b),b})},k.prototype.abort=function(){var a=this;return this._changeState("Aborted").then(function(b){return a.id=null,a.emit("abort",b),b},function(b){throw a.emit("error",b),b})},k.prototype._changeState=function(a,b){var c=this,d=this._bulk,e=d._logger;return this._jobInfo=this._waitAssign().then(function(){var b=['<?xml version="1.0" encoding="UTF-8"?>','<jobInfo xmlns="http://www.force.com/2009/06/asyncapi/dataload">',"<state>"+a+"</state>","</jobInfo>"].join("");return d._request({method:"POST",path:"/job/"+c.id,body:b,headers:{"Content-Type":"application/xml; charset=utf-8"},responseType:"application/xml"})}).then(function(a){return e.debug(a.jobInfo),c.state=a.jobInfo.state,a.jobInfo}),this._jobInfo.thenCall(b)};var l=function(a,b){l.super_.apply(this),this.sendable=!0,this.job=a,this.id=b,this._bulk=a._bulk,this._csvStream=new h.CSVStream({nullValue:"#N/A"}),this._csvStream.stream().pipe(this.stream()),this._deferred=i.defer()};c(l,h),l.prototype.run=l.prototype.exec=l.prototype.execute=function(a,b){var c=this;if("function"==typeof a&&(b=a,a=null),this._result)throw new Error("Batch already executed.");var d=i.defer();if(this._result=d.promise,this._result.then(function(a){c._deferred.resolve(a)},function(a){c._deferred.reject(a)}),this.once("response",function(a){d.resolve(a)}),this.once("error",function(a){d.reject(a)}),a instanceof e)a.pipe(this.stream());else{var f;if(g.isArray(a))g.forEach(a,function(a){c.send(a)}),c.end();else if(g.isString(a)){f=a;var h=this.stream();h.write(f),h.end()}}return this.thenCall(b)},l.prototype.then=function(a,b,c){return this._deferred.promise.then(a,b,c)},l.prototype.thenCall=function(b){return g.isFunction(b)&&this.then(function(c){a.nextTick(function(){b(null,c)})},function(c){a.nextTick(function(){b(c)})}),this},l.prototype.send=function(a){return a=g.clone(a),"insert"===this.job.operation?delete a.Id:"delete"===this.job.operation&&(a={Id:a.Id}),delete a.type,delete a.attributes,this._csvStream.send(a)},l.prototype.end=function(a){a&&this.send(a),this.sendable=!1,this._csvStream.end()},l.prototype.check=function(a){var b=this._bulk,c=b._logger,d=this.job.id,e=this.id;if(!d||!e)throw new Error("Batch not started.");return b._request({method:"GET",path:"/job/"+d+"/batch/"+e,responseType:"application/xml"}).then(function(a){return c.debug(a.batchInfo),a.batchInfo}).thenCall(a)},l.prototype.poll=function(a,b){var c=this,d=this.job.id,e=this.id;if(!d||!e)throw new Error("Batch not started.");var f=(new Date).getTime(),g=function(){var h=(new Date).getTime();if(h>f+b){var i=new Error("Polling time out. Job Id = "+d+" , batch Id = "+e);return i.name="PollingTimeout",void c.emit("error",i)}c.check(function(b,d){b?c.emit("error",b):"Failed"===d.state?parseInt(d.numberRecordsProcessed,10)>0?c.retrieve():c.emit("error",new Error(d.stateMessage)):"Completed"===d.state?c.retrieve():(c.emit("progress",d),setTimeout(g,a))})};setTimeout(g,a)},l.prototype.retrieve=function(a){var b=this,c=this._bulk,d=this.job.id,e=this.job,f=this.id;if(!d||!f)throw new Error("Batch not started.");return e.info().then(function(){return c._request({method:"GET",path:"/job/"+d+"/batch/"+f+"/result"})}).then(function(a){var h;if("query"===e.operation){{c._conn,a["result-list"].result}h=a["result-list"].result,h=g.map(g.isArray(h)?h:[h],function(a){return{id:a,batchId:f,jobId:d}})}else h=g.map(a,function(a){return{id:a.Id||null,success:"true"===a.Success,errors:a.Error?[a.Error]:[]}});return b.emit("response",h),h},function(a){throw b.emit("error",a),a}).thenCall(a)},l.prototype.result=function(a){var b=this.job.id,c=this.id;if(!b||!c)throw new Error("Batch not started.");return new h.CSVStream(null,this._bulk._request({method:"GET",path:"/job/"+b+"/batch/"+c+"/result/"+a}).stream())},l.prototype.stream=function(){return this._stream||(this._stream=new m(this)),this._stream};var m=function(a){m.super_.call(this),this.batch=a,this.writable=!0};c(m,e),m.prototype._getRequestStream=function(){var a=this.batch,b=a._bulk,c=b._logger;return this._reqStream||(this._reqStream=b._request({method:"POST",path:"/job/"+a.job.id+"/batch",headers:{"Content-Type":"text/csv"},responseType:"application/xml"},function(b,d){b?a.emit("error",b):(c.debug(d.batchInfo),a.id=d.batchInfo.id,a.emit("queue",d.batchInfo))}).stream()),this._reqStream},m.prototype.write=function(a){var b=this;this.batch.job.open().then(function(){b._getRequestStream().write(a)},function(a){b.emit("error",a)})},m.prototype.end=function(a){var b=this;this.writable=!1,this.batch.job.open().then(function(){b._getRequestStream().end(a)},function(a){b.emit("error",a)})};var n=function(){n.super_.apply(this,arguments)};c(n,j),n.prototype.beforeSend=function(a){a.headers=a.headers||{},a.headers["X-SFDC-SESSION"]=this._conn.accessToken},n.prototype.isSessionExpired=function(a){return 400===a.statusCode&&/<exceptionCode>InvalidSessionId<\/exceptionCode>/.test(a.body)},n.prototype.hasErrorInResponseBody=function(a){return!!a.error},n.prototype.parseError=function(a){return{errorCode:a.error.exceptionCode,message:a.error.exceptionMessage}};var o=function(a){this._conn=a,this._logger=a._logger};o.prototype.pollInterval=1e3,o.prototype.pollTimeout=1e4,o.prototype._request=function(a,b){var c=this._conn;a=g.clone(a);var d=[c.instanceUrl,"services/async",c.version].join("/");a.url=d+a.path;var e={responseType:a.responseType};return delete a.path,delete a.responseType,new n(this._conn,e).request(a).thenCall(b)},o.prototype.load=function(a,b,c,d,e){var f=this;if(!a||!b)throw new Error("Insufficient arguments. At least, 'type' and 'operation' are required.");"upsert"!==b.toLowerCase()&&(e=d,d=c,c=null);var g=this.createJob(a,b,c);g.once("error",function(a){h&&h.emit("error",a)});var h=g.createBatch(),i=function(){h=null,g.close()},j=function(a){"PollingTimeout"!==a.name&&i()};return h.on("response",i),h.on("error",j),h.on("queue",function(){h.poll(f.pollInterval,f.pollTimeout)}),h.execute(d,e)},o.prototype.query=function(a){var b=a.replace(/\([\s\S]+\)/g,"").match(/FROM\s+(\w+)/i);if(!b)throw new Error("No sobject type found in query, maybe caused by invalid SOQL.");var c=b[1],d=this,e=new h.CSVStream;return this.load(c,"query",a).then(function(a){var b=a[0],c=d.job(b.jobId).batch(b.batchId).result(b.id);c.stream().pipe(e.stream())}),e},o.prototype.createJob=function(a,b,c){return new k(this,a,b,c)},o.prototype.job=function(a){return new k(this,null,null,null,a)},b.exports=o}).call(this,a("_process"))},{_process:2}],2:[function(a,b){function c(){if(!g){g=!0;for(var a,b=f.length;b;){a=f,f=[];for(var c=-1;++c<b;)a[c]();b=f.length}g=!1}}function d(){}var e=b.exports={},f=[],g=!1;e.nextTick=function(a){f.push(a),g||setTimeout(c,0)},e.title="browser",e.browser=!0,e.env={},e.argv=[],e.version="",e.on=d,e.addListener=d,e.once=d,e.off=d,e.removeListener=d,e.removeAllListeners=d,e.emit=d,e.binding=function(){throw new Error("process.binding is not supported")},e.cwd=function(){return"/"},e.chdir=function(){throw new Error("process.chdir is not supported")},e.umask=function(){return 0}},{}]},{},[1])(1)});
//# sourceMappingURL=jsforce-api-bulk.min.js.map